{% extends "layout.html" %}

{% block title %}
    Game Catalog
{% endblock %}

{% block main %}
    <h1 class="text-center mb-4">Game Catalog</h1>
    
    <div class="search-container mb-4">
        <form method="GET" action="{{ url_for('index') }}" class="search-form row g-3 justify-content-center align-items-center">
            
            <div class="col-auto">
                <input type="text" 
                    name="search" 
                    class="form-control" 
                    placeholder="Search for a game..."
                    value="{{ search_query }}"
                    hx-get="/" 
                    hx-trigger="keyup changed delay:500ms" 
                    hx-target="#games-container" 
                    hx-swap="innerHTML">
            </div>

            <div class="col-auto">
                <select name="tag" class="form-select">
                    <option value="">All Tags</option>
                    {% for tag in tags %}
                        <option value="{{ tag.tag_name }}"
                                {% if selected_tag == tag.tag_name %}selected{% endif %}>
                            {{ tag.tag_name }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-auto">
                <select name="sort" class="form-select" onchange="this.form.submit()">
                    <option value="newest" {% if sort_by == 'newest' %}selected{% endif %}>Newest Releases</option>
                    <option value="price_asc" {% if sort_by == 'price_asc' %}selected{% endif %}>Price: Low to High</option>
                    <option value="price_desc" {% if sort_by == 'price_desc' %}selected{% endif %}>Price: High to Low</option>
                    <option value="title_asc" {% if sort_by == 'title_asc' %}selected{% endif %}>Name: A-Z</option>
                </select>
            </div>

            <div class="col-auto">
                <button type="submit" class="btn btn-primary">Filter</button>
            </div>
        </form>
    </div>

    <div class="games-container" id="games-container">
        {% include '_games_grid.html' %}
    </div>

    {% if total_pages > 1 %}
    <nav aria-label="Page navigation" class="mt-4">
        <ul class="pagination justify-content-center">
            
            <li class="page-item {% if page == 1 %}disabled{% endif %}">
                <a class="page-link" href="{{ url_for('index', page=page-1, search=search_query, tag=selected_tag, sort=sort_by) }}">Previous</a>
            </li>

            {% for p in range(1, total_pages + 1) %}
                <li class="page-item {% if p == page %}active{% endif %}">
                    <a class="page-link" href="{{ url_for('index', page=p, search=search_query, tag=selected_tag, sort=sort_by) }}">
                        {{ p }}
                    </a>
                </li>
            {% endfor %}

            <li class="page-item {% if page == total_pages %}disabled{% endif %}">
                <a class="page-link" href="{{ url_for('index', page=page+1, search=search_query, tag=selected_tag, sort=sort_by) }}">Next</a>
            </li>
        </ul>
    </nav>
    {% endif %}

    <script>
        let timeout = null;
        const searchInput = document.getElementById('search-input');
        const gamesContainer = document.getElementById('games-container');

        searchInput.addEventListener('input', function() {
            clearTimeout(timeout);

            // Затримка 300мс перед відправкою запиту
            timeout = setTimeout(() => {
                const query = searchInput.value;
                
                fetch(`/?search=${encodeURIComponent(query)}`, {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.text())
                .then(html => {
                    gamesContainer.innerHTML = html;
                })
                .catch(err => console.error('Error:', err));
            }, 300);
        });
    </script>

{% endblock %}